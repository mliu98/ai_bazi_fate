# 八字排盘完整计算方法

我来系统梳理从生辰到八字的完整算法，重点标注常见错误点。

---

## 一、八字基本概念

八字由**年柱、月柱、日柱、时柱**组成，每柱一个天干 + 一个地支，共 8 个字。

```
年柱：年天干 + 年地支
月柱：月天干 + 月地支  
日柱：日天干 + 日地支
时柱：时天干 + 时地支
```

---

## 二、基础数据表

### 天干（10个，循环）
```
序号：  0   1   2   3   4   5   6   7   8   9
天干：  甲  乙  丙  丁  戊  己  庚  辛  壬  癸
五行：  木  木  火  火  土  土  金  金  水  水
阴阳：  阳  阴  阳  阴  阳  阴  阳  阴  阳  阴
```

### 地支（12个，循环）
```
序号：  0   1   2   3   4   5   6   7   8   9   10  11
地支：  子  丑  寅  卯  辰  巳  午  未  申  酉  戌  亥
五行：  水  土  木  木  土  火  火  土  金  金  土  水
月份：  11  12   1   2   3   4   5   6   7   8   9  10  （对应农历月，但月柱用节气）
时辰：  23  01  03  05  07  09  11  13  15  17  19  21  （每时辰起始时刻）
```

---

## 三、年柱计算

### ⚠️ 关键规则：以「立春」为年份分界，不是元旦也不是春节

**常见错误**：用公历1月1日或农历正月初一作为年份分界，这是错误的。

**正确做法**：
- 如果生日在该年「立春」**之前**（含当天立春时刻之前）→ 年柱属于**上一年**
- 如果生日在该年「立春」**之后**→ 年柱属于**本年**

**立春日期参考（公历，每年略有差异）：**
```
一般在每年公历 2月3日～2月5日之间
精确时刻需查万年历（例：2000年立春为2月4日17:44）
```

### 年干计算公式

```
年干序号 = (公历年份 - 4) mod 10
```

示例：2000年 → (2000 - 4) mod 10 = 1996 mod 10 = **6** → 对应**庚**

### 年支计算公式

```
年支序号 = (公历年份 - 4) mod 12
```

示例：2000年 → (2000 - 4) mod 12 = 1996 mod 12 = **4** → 对应**辰**

所以2000年（立春后）= **庚辰**年 ✓

### 快速验证
- 1984年 = 甲子年（序号0,0）→ (1984-4)mod10=0甲，(1984-4)mod12=0子 ✓
- 2024年 = 甲辰年 ✓

---

## 四、月柱计算

### ⚠️ 关键规则：月柱以「节」为分界，不是农历初一

**这是最容易出错的地方。** 八字月份用的是**节气中的「节」**，不是「气」，更不是农历月份。

**12个节对应的月支：**
```
月支   节名     公历大约日期    对应月份（虎月=寅月=正月）
寅月   立春     2月3-5日       正月
卯月   惊蛰     3月5-7日       二月
辰月   清明     4月4-6日       三月
巳月   立夏     5月5-7日       四月
午月   芒种     6月5-7日       五月
未月   小暑     7月6-8日       六月
申月   立秋     8月7-9日       七月
酉月   白露     9月7-9日       八月
戌月   寒露     10月7-9日      九月
亥月   立冬     11月7-8日      十月
子月   大雪     12月6-8日      十一月
丑月   小寒     1月5-7日       十二月
```

**规则**：看生日处于哪两个「节」之间，月支就是前一个节对应的月支。

### 月干：由年干和月支共同确定（五虎遁年起月法）

**口诀（五虎遁）**：
```
甲己之年丙作首（甲年、己年，正月（寅月）起丙寅）
乙庚之年戊为头（乙年、庚年，正月起戊寅）
丙辛之年寻庚上（丙年、辛年，正月起庚寅）
丁壬之年壬寅流（丁年、壬年，正月起壬寅）
戊癸之年甲寅居（戊年、癸年，正月起甲寅）
```

**月干推算表（寅月=正月=1月起）：**

| 年干 | 寅月 | 卯月 | 辰月 | 巳月 | 午月 | 未月 | 申月 | 酉月 | 戌月 | 亥月 | 子月 | 丑月 |
|------|------|------|------|------|------|------|------|------|------|------|------|------|
| 甲/己 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 |
| 乙/庚 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 |
| 丙/辛 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 |
| 丁/壬 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 |
| 戊/癸 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 |

**示例**：
- 2000年（庚辰年，年干=庚），生于3月20日（惊蛰后、清明前，卯月）
- 年干庚 → 乙/庚行 → 卯月对应**己** → 月柱 = **己卯**

---

## 五、日柱计算

### ⚠️ 关键规则：以北京时间 23:00（子时）为日期分界

**常见错误**：用公历0:00午夜作为日期分界。

**正确规则**：
- 23:00（子时初）之后出生 → 八字日期为**第二天**
- 23:00 之前出生 → 八字日期为**当天**

### 日柱计算（蔡勒公式 / 查表法）

日柱不能简单推算，需要用固定算法。推荐使用「以某基准日为锚点」的方法。

**基准日**：1900年1月1日 = 甲戌日（干支序号第10）

**干支序号 = 0对应甲子，59对应癸亥，循环**

```
总天干支序号 = (基准干支序号 + 距基准日天数) mod 60
天干序号 = 总序号 mod 10
地支序号 = 总序号 mod 12
```

**距离天数计算**：用目标日期距1900年1月1日的总天数（需精确计算，包括闰年）。

**实用方法（编程实现）**：

```javascript
function getDayGanzhi(year, month, day) {
  // 1900年1月1日是甲戌日，干支序号为10（甲=0,子=0; 甲戌=干0支10=序号10）
  // 用Julian Day Number计算更准确
  
  const baseDate = new Date(1900, 0, 1); // 1900-01-01
  const targetDate = new Date(year, month - 1, day);
  const diffDays = Math.round((targetDate - baseDate) / (1000 * 60 * 60 * 24));
  
  const baseGanzhiIndex = 10; // 甲戌=第10个干支（0-based：甲子=0）
  const ganzhiIndex = (baseGanzhiIndex + diffDays) % 60;
  
  const TG = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
  const DZ = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
  
  return TG[ganzhiIndex % 10] + DZ[ganzhiIndex % 12];
}
```

**⚠️ 注意**：如果出生时间 ≥ 23:00，day + 1 后再计算。

---

## 六、时柱计算

### 时支：按出生时刻确定（固定不变）

```
子时：23:00 - 00:59    午时：11:00 - 12:59
丑时：01:00 - 02:59    未时：13:00 - 14:59
寅时：03:00 - 04:59    申时：15:00 - 16:59
卯时：05:00 - 06:59    酉时：17:00 - 18:59
辰时：07:00 - 08:59    戌时：19:00 - 20:59
巳时：09:00 - 10:59    亥时：21:00 - 22:59
```

**⚠️ 时区问题**：八字用的是「真太阳时」，如果要严格计算需考虑经度偏差。但实际应用中通常用**北京时间（东八区）**即可，偏差在1小时内对大部分时辰不影响结果。

### 时干：由日干确定（五鼠遁日起时法）

**口诀（五鼠遁）**：
```
甲己还加甲（甲日、己日，子时起甲子）
乙庚丙作初（乙日、庚日，子时起丙子）
丙辛从戊起（丙日、辛日，子时起戊子）
丁壬庚子居（丁日、壬日，子时起庚子）
戊癸何方发，壬子是真途（戊日、癸日，子时起壬子）
```

**时干推算表（子时=0时起）：**

| 日干 | 子 | 丑 | 寅 | 卯 | 辰 | 巳 | 午 | 未 | 申 | 酉 | 戌 | 亥 |
|------|----|----|----|----|----|----|----|----|----|----|----|----|
| 甲/己 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 |
| 乙/庚 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 |
| 丙/辛 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 |
| 丁/壬 | 庚 | 辛 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 |
| 戊/癸 | 壬 | 癸 | 甲 | 乙 | 丙 | 丁 | 戊 | 己 | 庚 | 辛 | 壬 | 癸 |

---

## 七、完整示例验证

**以你 app 中的「晓雨」为例：2000年3月15日 卯时（05:00-07:00）**

### 第一步：年柱
- 2000年立春：2月4日 17:44
- 3月15日在立春之后 → 属于庚辰年
- 年干：(2000-4) mod 10 = 6 → **庚**
- 年支：(2000-4) mod 12 = 4 → **辰**
- ✅ **年柱：庚辰**

### 第二步：月柱
- 3月15日：惊蛰（3月5日）之后、清明（4月4日）之前 → **卯月**
- 年干庚 → 乙/庚行 → 卯月天干 = **己**
- ✅ **月柱：己卯**

### 第三步：日柱
- 卯时（05:00-07:00），不超过23:00，日期不进位，仍为3月15日
- 计算距1900-01-01天数（精确）：
  - 1900-01-01 → 2000-01-01 = 100年，其中闰年：1904~1996 共 24 个（1900 不是闰年）→ 100×365 + 24 = **36524 天**
  - 2000-01-01 → 2000-03-15：1月31天 + 2月29天（2000为闰年）+ 14天 = **74 天**
  - 合计：36524 + 74 = **36598 天**
- (10 + 36598) mod 60 = 36608 mod 60 = **8**
- 天干：8 mod 10 = 8 → **壬**
- 地支：8 mod 12 = 8 → **申**
- ✅ **日柱：壬申**

> ~~（原文写 36589 天、结果 19 = 癸未，系笔误：36608 mod 60 = 8，非 19）~~

### 第四步：时柱
- 卯时（05:00-07:00）→ 时支 = **卯**（时支序号 = 6/2 = 3 → 卯 ✓）
- 日干**壬**（序号8）→ 丁/壬行 → 子时起庚(6) → 卯时（序号3）天干 = (6+3) mod 10 = 9 → **癸**
- ✅ **时柱：癸卯**

**最终结果：庚辰 · 己卯 · 壬申 · 癸卯**

---

## 八、常见错误总结

| 错误类型 | 错误做法 | 正确做法 |
|---------|---------|---------|
| 年柱分界 | 用元旦/春节 | 用立春（约2月4日，精确需查万年历） |
| 月柱分界 | 用农历初一 | 用节气的「节」（非「气」） |
| 日柱分界 | 用公历0:00 | 用北京时间23:00（子时归次日） |
| 月干推算 | 固定偏移 | 用五虎遁年起月法（由年干决定寅月起干） |
| 时干推算 | 固定偏移 | 用五鼠遁日起时法（由日干决定子时起干） |
| 日柱推算 | 用日期数直接取模 | 用基准日（1900-01-01=甲戌=序号10）+ 距今天数 mod 60 |
| 节气精度 | 只用日期 | 需要精确到时刻（同一天立春前后年柱不同） |

---

## 九、推荐实现方案

最可靠的做法是**内置一张精确的节气时刻表**（包含1900-2100年所有节气的精确时间），而不是用公式估算节气日期。节气时刻表可从中国科学院紫金山天文台数据或开源库（如 `lunar-javascript`、`chinese-lunar-calendar`）获取，这些库已经过严格校验，直接引用远比自己实现更安全。