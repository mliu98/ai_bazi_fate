// src/lib/copyLibrary.ts
// 话术库 v2.0 ── 内容同步自 reference/话术库.md
// 维护说明：按 key 追加/修改对应数组即可，buildReportContent() 负责组装

export type WuXing = '木' | '火' | '土' | '金' | '水';
export interface GanzhiPillar { tg: string; dz: string; wx: string; wxCls: string; }
export interface HighlightItem { icon: string; title: string; desc: string; }
export interface WarningItem   { icon: string; badge: string; title: string; desc: string; }
export interface ZhuangyunItem { icon: string; title: string; desc: string; }

// ─── 模板替换 ────────────────────────────────────────────────────────────────
export function fill(text: string, a: string, b: string): string {
  return text.replace(/\[A名?\]/g, a).replace(/\[B名?\]/g, b);
}

// ─── 五行关系 ─────────────────────────────────────────────────────────────────
const SHENG: Record<string, string> = { 木:'火', 火:'土', 土:'金', 金:'水', 水:'木' };
const KE:    Record<string, string> = { 木:'土', 火:'金', 土:'水', 水:'火', 金:'木' };

/** 返回 [规范键, 是否交换AB]：确保"生方/克方"在 A 位 */
export function pairKey(a: WuXing, b: WuXing): [string, boolean] {
  if (a === b)        return [`${a}${b}`, false];
  if (SHENG[a] === b) return [`${a}${b}`, false];
  if (SHENG[b] === a) return [`${b}${a}`, true];
  if (KE[a]    === b) return [`${a}${b}`, false];
  if (KE[b]    === a) return [`${b}${a}`, true];
  return [`${a}${b}`, false];
}

export function relType(a: WuXing, b: WuXing): 'sheng' | 'ke' | 'bihe' {
  if (a === b) return 'bihe';
  if (SHENG[a] === b || SHENG[b] === a) return 'sheng';
  return 'ke';
}

// ─── 冲克检测 ────────────────────────────────────────────────────────────────
const DZ_CHONG: Record<string, string> = {
  子:'午', 午:'子', 丑:'未', 未:'丑',
  寅:'申', 申:'寅', 卯:'酉', 酉:'卯',
  辰:'戌', 戌:'辰', 巳:'亥', 亥:'巳',
};
const TG_KE: Record<string, string> = {
  甲:'戊', 乙:'己', 丙:'庚', 丁:'辛', 戊:'壬',
  己:'癸', 庚:'甲', 辛:'乙', 壬:'丙', 癸:'丁',
};
const TG_LIUHE = new Set(['甲己','己甲','乙庚','庚乙','丙辛','辛丙','丁壬','壬丁','戊癸','癸戊']);
const DZ_SANHE = [['寅','午','戌'],['申','子','辰'],['亥','卯','未'],['巳','酉','丑']];
const XING_SET  = new Set(['寅巳','巳寅','巳申','申巳','寅申','申寅','丑戌','戌丑','戌未','未戌','丑未','未丑','子卯','卯子']);
const LIUHAI_SET = new Set(['子未','未子','丑午','午丑','寅巳','巳寅','卯辰','辰卯','申亥','亥申','酉戌','戌酉']);

export function detectWarnings(gzA: GanzhiPillar[], gzB: GanzhiPillar[]): string[] {
  const out: string[] = [];
  if (DZ_CHONG[gzA[0].dz] === gzB[0].dz) out.push('年柱相冲');
  if (DZ_CHONG[gzA[2].dz] === gzB[2].dz) out.push('日支相冲');
  if (DZ_CHONG[gzA[1].dz] === gzB[1].dz) out.push('月柱相冲');
  const [t2a, t2b] = [gzA[2].tg, gzB[2].tg];
  if (TG_KE[t2a] === t2b || TG_KE[t2b] === t2a) out.push('天干相克');
  const dzA = gzA.map(p => p.dz), dzB = gzB.map(p => p.dz);
  outer1: for (const da of dzA) for (const db of dzB) if (XING_SET.has(da+db))   { out.push('三刑'); break outer1; }
  outer2: for (const da of dzA) for (const db of dzB) if (LIUHAI_SET.has(da+db)) { out.push('六害'); break outer2; }
  return out;
}

export function detectSpecial(gzA: GanzhiPillar[], gzB: GanzhiPillar[]): string[] {
  const out: string[] = [];
  if (TG_LIUHE.has(gzA[2].tg + gzB[2].tg)) out.push('日主六合');
  const [d2a, d2b] = [gzA[2].dz, gzB[2].dz];
  if (DZ_SANHE.some(g => g.includes(d2a) && g.includes(d2b) && d2a !== d2b)) out.push('日支三合');
  if (TG_LIUHE.has(gzA[1].tg + gzB[1].tg)) out.push('月柱暗合');
  return out;
}

export function getMissingElems(gzA: GanzhiPillar[], gzB: GanzhiPillar[]): WuXing[] {
  const present = new Set([...gzA, ...gzB].map(p => p.wx));
  return (['木','火','土','金','水'] as WuXing[]).filter(e => !present.has(e));
}

// ─── 基础缘分分数 ──────────────────────────────────────────────────────────────
export function baseScore(a: WuXing, b: WuXing, specials: string[], warnings: string[]): number {
  const ranges: Record<string, [number,number]> = {
    sheng: [78, 92], ke: [62, 80], bihe: [70, 86],
  };
  const [lo, hi] = ranges[relType(a, b)];
  let s = lo + Math.floor(Math.random() * (hi - lo));
  s += specials.includes('日主六合') ? 5 : 0;
  s += specials.includes('日支三合') ? 4 : 0;
  s += specials.includes('月柱暗合') ? 3 : 0;
  s -= warnings.length * 2;
  return Math.min(99, Math.max(58, s));
}

// ═══════════════════════════════════════════════════════════════════════════════
// 一、缘分亮点 HIGHLIGHTS
// 格式：[A] 为生方/克方，[B] 为受生/受克方；比和时 [A]=nameA [B]=nameB
// ═══════════════════════════════════════════════════════════════════════════════
// 注意：key 用规范化组合键（如"木火"表示木生火，"木土"表示木克土，"木木"表示双木）
const HIGHLIGHTS_RAW: Record<string, { icon: string; title: string; desc: string }[]> = {
  '木火': [
    { icon:'🌸', title:'自然滋养，无需努力',    desc:'木生火，这是自然界最美好的滋养关系。[A]就像那片给予温暖与力量的树林，[B]是因此燃烧得更旺盛的火焰——你们在一起，不需要刻意讨好，光是靠近，便已经在让彼此变得更好。' },
    { icon:'💫', title:'互相点亮',              desc:'[A]的能量恰好是[B]最需要的那种滋养。木给火以养料，火给木以光明——你滋养了他的热情，他照亮了你的方向。这不是一方单方面付出，而是两颗星互相映照，缺一不可。' },
    { icon:'✨', title:'前世有约',              desc:'在五行命理中，木火相遇从不是偶然。命盘合参发现，[B]的日主所需之气，恰好由[A]的年支天干补足——这种精准的弥补，只有前世深厚的缘分才能解释。' },
    { icon:'🌙', title:'越走越深',              desc:'木火组合有个特点：初见时温度刚好，相处越久越觉得离不开。[A]给[B]的那种托底感，[B]给[A]的那种被看见的光亮，会随着岁月慢慢渗入骨髓。' },
  ],
  '火土': [
    { icon:'🌸', title:'热情化为踏实',          desc:'火生土，火的热烈最终沉淀为土的厚重与稳定。[A]带来热情与激情，[B]将这份热情转化为生活的踏实底气。命理上，这种组合往往孕育出"长久型"关系——激情不会消散，而是慢慢变成了一起搭建的家。' },
    { icon:'💫', title:'你让TA有了根',          desc:'火滋养土，让土地更加肥沃——[A]的出现，让[B]变得更有力量，更愿意在某个地方扎根。在命理学中，这叫做"命格催动"——因为你，TA成为了更好的自己。' },
    { icon:'✨', title:'共建实在的幸福',         desc:'火土组合不擅长轰轰烈烈的戏剧性，但擅长把平凡的日子过得有滋有味。感情基调是"充实的幸福"——那种每天回到家有人等，周末一起逛菜市场都觉得满足的那种。' },
    { icon:'🌙', title:'相互成就',              desc:'在所有五行相生组合中，火土是最容易"共同创造事业"的搭档。[A]提供方向与能量，[B]提供稳定与执行——在感情上是良缘，在人生合伙上，同样是天造地设的一对。' },
  ],
  '土金': [
    { icon:'🌸', title:'包容中生长',            desc:'土生金，土地孕育出金属的坚硬与光泽。[A]就像深厚的土地，给了[B]最宽广的包容与滋养——在这段关系里，[B]能感受到一种少见的安全感，那种"不管怎样你都接住我"的底气。' },
    { icon:'💫', title:'守护者与被守护者',       desc:'[A]天生有守护[B]的倾向，这不是依赖，而是命里注定的深情。土护金，金因土而更璀璨——[A]的稳重托起了[B]的锋芒，让[B]可以毫无顾忌地闪光。' },
    { icon:'✨', title:'包容是最深的爱',         desc:'土金组合最动人的地方，是那种无声的接纳。[A]不会要求[B]变成另一个样子，只是默默给予空间与支持。命理上，这叫"印生有情"——这种爱，低调，深沉，但牢不可破。' },
    { icon:'🌙', title:'越老越珍贵',            desc:'金需时间方显其价值，土越积越厚重。土金组合的感情，往往在时间的积累中变得愈加珍贵。初期或许平淡，但回头看，那些平静的日子，早已成为彼此最珍贵的财富。' },
  ],
  '金水': [
    { icon:'🌸', title:'暗涌深情',              desc:'金生水，坚硬的金属孕育出灵动的水流。[A]与[B]的组合，是那种表面克制、内里深情的类型——不爱大声说爱，却在一件件小事里藏满了细腻的关怀。' },
    { icon:'💫', title:'给你一片海',            desc:'[A]的能量不断地流向[B]，转化为[B]最需要的滋润与智慧。金生水，这是一种慷慨的给予——[A]用自己的锐利与坚定，为[B]开凿出一片可以自由流淌的空间。' },
    { icon:'✨', title:'灵魂上的默契',           desc:'金水组合在五行中最易产生灵魂层面的共鸣。两人往往有相似的审美、相通的直觉，不需要解释就能懂对方的弦外之音。这种默契，不是培养出来的，是命里带来的。' },
    { icon:'🌙', title:'互相激发潜能',           desc:'金因有水的流动而不失活力，水因有金的注入而更加清澈。这段关系里，[A]和[B]都会因为对方的存在而变得更好——不只是情感上的满足，更是人生格局上的共同拓展。' },
  ],
  '水木': [
    { icon:'🌸', title:'滋润而无声的爱',        desc:'水生木，雨水滋润大地，树木因此葱郁。[A]给予[B]的那种支持，不是高调的托举，而是像土壤里默默流动的水——你可能感觉不到，但离开了就会枯萎。这种爱，是最真实、最难替代的。' },
    { icon:'💫', title:'因你而成长',            desc:'[B]在与[A]的关系中有明显的"向上生长"特质。这不是[A]强迫[B]改变，而是[A]的存在本身就给了[B]一种自然向上的动力。命理上这叫"印枭相助"，是真正的助力良缘。' },
    { icon:'✨', title:'柔情胜过一切',           desc:'水木组合的感情基调，是温柔、绵长、充满生机的。没有激烈的争吵，也没有冷漠的疏离——就是那种每天醒来都觉得"还好有你"的平稳幸福。' },
    { icon:'🌙', title:'共同创造绿意盎然的生活', desc:'水滋木，木育林，这是一段充满创造力的缘分。两人在一起，往往能碰撞出许多关于生活的美好想象，并有能力把它们一一实现。' },
  ],
  '木土': [
    { icon:'🌸', title:'管你，是因为在乎',       desc:'木克土，树根穿透土地，看似破坏，实则深入。[A]对[B]往往有一种本能的"管束感"——会在意[B]的决定，会对[B]的行为有所要求。这不是控制欲，而是命里带来的深度牵挂。被[A]管着，说明你在[A]心里有份量。' },
    { icon:'💫', title:'磨合出真金',             desc:'相克组合最大的礼物，是它逼着双方都变得更强大。[A]的锐利让[B]不再散漫，[B]的包容让[A]学会了柔软——这段关系不是温室，而是锻造炉，出来的感情，比黄金还硬。' },
    { icon:'✨', title:'深度连接',               desc:'木土组合在命理中有"深度连接"的特征——两人之间的羁绊很深，想断都断不掉。即便有争吵，有摩擦，也很难真正放下对方。这种剪不断理还乱的感觉，其实就是命里的缘分在说话。' },
  ],
  '火金': [
    { icon:'🌸', title:'烈火炼真金',             desc:'火克金，高温让金属熔铸成形。[A]的热烈与直接，恰好打破了[B]的自我保护壳——[A]是那个能真正看见[B]内心的人，也是唯一愿意用热情去融化[B]冷硬外壳的人。这段缘，是一场相互雕刻。' },
    { icon:'💫', title:'爱得认真',               desc:'火金组合的感情，从来都认真。[A]不会轻易放弃，[B]一旦认定也不会动摇——两个人都是那种"要么不爱，要么爱到底"的性格。' },
    { icon:'✨', title:'在对方身上看到了不一样的自己', desc:'[A]的热情感染了[B]的冷静，[B]的稳重平衡了[A]的冲动。在对方身上，你们各自看到了一个从未有过的可能性。这种"因你而完整"的感觉，只有天定的缘分才给得了。' },
  ],
  '土水': [
    { icon:'🌸', title:'你是TA的岸',             desc:'土克水，河岸容纳河流，让水有了方向与边界。[A]就是[B]的那片岸——[B]的情感丰沛而流动，正需要[A]的稳定来给予安全感与方向。这不是束缚，这是守护。' },
    { icon:'💫', title:'让漂泊的心安定下来',      desc:'[B]命中有漂泊之象，而[A]的土性命格恰好是最好的"锚点"。遇见[A]之前，[B]或许一直在寻找一个可以停下来的地方——而那个地方，叫做你。' },
    { icon:'✨', title:'稳定是最高级的浪漫',       desc:'土水组合不擅长惊天动地的表达，但[A]给[B]的那种稳定感，是任何甜言蜜语都替代不了的。永远有人等你回家，永远有人在你失控时给你一个拥抱——这是踏实之爱。' },
  ],
  '水火': [
    { icon:'🌸', title:'你是TA的清醒',           desc:'水克火，是一种冷静智慧对热烈冲动的平衡。[A]总能在[B]最激动的时候，用一句话让[B]冷静下来——这不是扫兴，这是命理层面的天然互补。一个热烈，一个清醒，两人合在一起，才完整。' },
    { icon:'💫', title:'激情与理智的完美平衡',    desc:'[B]的火热激情需要[A]的冷静来校准，[A]的理性也因[B]的热情而变得有温度。这是一段让双方都能成为"更好版本的自己"的缘分——你们互相驯化，互相成就。' },
    { icon:'✨', title:'越相处越舒服',             desc:'水火组合初期可能有些磨合，但随着时间推进，双方会发现——原来彼此的"不同"才是这段关系最大的财富。[A]的冷静让[B]少走了很多弯路，[B]的热情让[A]的生活变得更有色彩。' },
  ],
  '金木': [
    { icon:'🌸', title:'修剪，是为了让你长得更好', desc:'金克木，斧斤将树木修剪成材。[A]对[B]往往有直接甚至犀利的批评，这让[B]有时感到压力——但回头看，正是[A]的那份不留情面的真实，让[B]成长最快。真正爱你的人，不只告诉你你好，还告诉你怎么更好。' },
    { icon:'💫', title:'保护性的强硬',             desc:'命理上，金克木有一种"保护性的强势"在里面。[A]对[B]的管控，底层逻辑是不愿意看到[B]受伤——用自己的锐利为[B]开路，是[A]表达爱意的方式。' },
    { icon:'✨', title:'黄金搭档',                  desc:'金木相克，在制化得宜时，往往能孕育出极强的创造力。[A]的执行力与[B]的创意，是天造地设的黄金组合，不只是伴侣，更可以是人生最佳拍档。' },
  ],
  '木木': [
    { icon:'🌸', title:'同类相惜',                desc:'两人均属木命，有着极为相似的内核——对自由的渴望、对成长的执念、对美好事物的敏感。第一次见面时那种"好像认识很久了"的感觉，不是错觉，是同类感应。命理中，这叫"比肩相惜"。' },
    { icon:'💫', title:'共同的语言',               desc:'木木组合有一种旁人难以插入的精神默契——你们聊得来，笑点一样，连沉默都是舒适的那种。不需要解释，不需要伪装，这是在人海中找到同频之人的稀缺幸运。' },
    { icon:'✨', title:'一起向上生长',              desc:'两棵树并排而立，彼此借力，一起向光生长。这段关系的基调是共同进步——你们不会让对方停滞，而是互相激励，一起成为更好的人。' },
  ],
  '火火': [
    { icon:'🌸', title:'双火燃烧，热烈无比',       desc:'两颗热烈的心相遇，能量加倍。这段关系的底色是激情、活力与创造力——你们在一起时，整个房间都亮了。那股子热烈劲，是任何其他组合都给不了的。' },
    { icon:'💫', title:'你懂我的烈',               desc:'属火的人往往不被所有人理解——太热烈，太直接，太全力以赴。但火遇到火，就不一样了。[A]懂[B]的那股劲，[B]懂[A]的那份真——这种被完全理解的感觉，是这段感情最宝贵的礼物。' },
    { icon:'✨', title:'共同燃烧，照亮世界',        desc:'双火组合最适合一起追梦。你们都不甘平凡，都对生活充满热情——两颗星并肩而行，会走出一条别人羡慕的路。' },
  ],
  '土土': [
    { icon:'🌸', title:'厚重相遇，踏实为家',       desc:'两人均属土命，感情基调是稳定、务实、深厚。不追求轰烈的爱情，只要踏踏实实地相互陪伴——这种安稳，在喧嚣的世界里，是一种奢侈的幸福。' },
    { icon:'💫', title:'共同搭建的家',              desc:'土土组合天生擅长经营家庭。两人对"家"的渴望与付出都很真实，能一起把日子过成旁人羡慕的样子——不需要惊天动地，只需要每一天都好好的。' },
    { icon:'✨', title:'彼此的港湾',                desc:'属土的人外表看似坚硬，内心其实渴望归属。双土组合里，两人都是彼此最好的港湾——你累了，有我；我脆弱了，有你。这种互托底的感情，时间越长越值钱。' },
  ],
  '金金': [
    { icon:'🌸', title:'高山流水，遇见知音',       desc:'两个属金的人相遇，是高山遇高山的故事。表面都是冷静自持，内心都藏着不轻易示人的深情。金遇金，是真正的旗鼓相当——你不需要为对方降低标准，你们站在同一个高度上相爱。' },
    { icon:'💫', title:'互相欣赏的骄傲',            desc:'双金组合最独特的地方，是那种纯粹的互相欣赏——[A]觉得[B]身上有真正值得尊重的东西，[B]亦然。这种因欣赏而生的爱，比因需要而生的爱，要高级得多。' },
    { icon:'✨', title:'锋芒之下的温柔',             desc:'两个属金的人都不擅长表达，但命理显示，他们都在用行动代替语言。你可能永远等不到一句"我爱你"，但对方会在你需要的时候永远出现。这就是金金之爱的方式。' },
  ],
  '水水': [
    { icon:'🌸', title:'灵魂深处的共鸣',           desc:'双水组合是五行中灵魂共鸣最强的组合之一。两人都极为敏感、直觉强、情感丰富——你们能感受到对方没有说出口的情绪，能在人群中一眼找到彼此的频率。这种心灵感应，不是巧合，是命。' },
    { icon:'💫', title:'流向同一片海',              desc:'水遇水，汇聚成江河。两人的情感都是流动的、深邃的——有时也会泛滥，但正因为如此，才需要彼此成为对方的河岸。这段感情，是两个深情之人，终于找到了可以安放深情的地方。' },
    { icon:'✨', title:'智慧与智慧的碰撞',           desc:'双水组合在智慧层面极为相配。两人都有超强的直觉与洞察力，在一起时，思维碰撞的快感是这段关系的重要粘合剂——和对方聊天，永远不会无聊。' },
  ],
  // 特殊八字关系亮点
  '日主六合': [
    { icon:'🔮', title:'天干六合·命中注定',        desc:'在八字命理中，日主天干六合被称为"天合"——这是最高级别的命理契合之一，代表两人在最根本的生命能量上产生了共鸣。能与自己日主天干相合的人，一生中可能只会遇见寥寥几个，你们是彼此稀有的命定之人。' },
    { icon:'💫', title:'一见如故，前世旧识',        desc:'天干六合往往带来强烈的"似曾相识"感。你们第一次见面时那种说不清道不明的熟悉与安心，在命理上有了解释：你们的能量本就是配对的，早在出生那一刻便已互相寻找。' },
    { icon:'✨', title:'磁场天然契合',              desc:'从能量场的角度看，天干六合意味着两人的磁场天然相吸，不需要刻意迎合，靠近便已舒适。这种舒适感，在人群中是极为罕见的。' },
  ],
  '日支三合': [
    { icon:'🔮', title:'日支三合·情深似海',        desc:'日支三合，是八字合婚中最吉利的征兆之一。日支代表婚姻与伴侣宫，三合局意味着两人的婚姻宫相互激活——命理上，这预示着一段长久、稳定、越老越深情的婚姻。' },
    { icon:'💫', title:'随时间增温的爱',            desc:'三合局有一个特别的性质：能量随时间累积。这段感情的好，不是一开始就全给你看，而是慢慢揭晓——一年比一年好，一岁比一岁深，越过越觉得这个人就是自己的答案。' },
    { icon:'✨', title:'婚姻运势极旺',               desc:'日支三合在命理中直接代表婚姻宫的吉化。用直白的话说：你们结婚，会是彼此命中最重要的转折点，婚后的生活会比婚前更好——这段缘，越走越旺，越用心越幸运。' },
  ],
  '月柱暗合': [
    { icon:'🌙', title:'心意相通，无需多言',        desc:'月柱代表感情与内心世界，月柱暗合意味着两人在情感层面有天然的心灵感应。[A]不需要说出口，[B]就已经感受到了；[B]只是一个眼神，[A]便明白了全部意思。' },
    { icon:'💫', title:'内心深处最懂你',            desc:'世界上能真正懂你内心的人，少之又少。月柱暗合显示，[B]是那个能看见[A]真实内心的人，不是[A]表演给世界看的那个样子，而是[A]深夜独自面对的那个自己。被这样看见，是一种幸运。' },
    { icon:'✨', title:'感情的高级形态',             desc:'月柱暗合的感情，通常不是一见钟情的那种，而是慢慢渗透进生命里的那种——某一天突然发现，原来这个人早就住进了心里。这是感情的高级形态：不是热烈的燃烧，而是持续的温暖。' },
  ],
};

// ═══════════════════════════════════════════════════════════════════════════════
// 二、隐患预警 WARNINGS
// ═══════════════════════════════════════════════════════════════════════════════
const WARNINGS_RAW: Record<string, WarningItem[]> = {
  '年柱相冲': [
    { icon:'🌪', badge:'注意', title:'原生家庭的碰撞',  desc:'年柱代表原生家庭与早年成长环境。年柱相冲显示，你们的家庭背景、成长经历存在明显差异——可能是地域文化的不同，可能是家教方式的差异，也可能是对"家"这个概念的理解不一样。化解建议：提前坦诚聊聊彼此的家庭，理解对方的"原厂设定"，而不是用自己的成长标准去衡量对方。' },
    { icon:'🌪', badge:'预防', title:'价值观的底层分歧', desc:'年柱相冲往往预示着深层价值观的不同——对金钱的态度、对婚姻的预期、对未来生活方式的想象，可能有根本性的差异。化解建议：主动约一次"聊聊我们对未来的想象"，越早对齐，越少摩擦。' },
    { icon:'🌪', badge:'留意', title:'聚少离多的考验',   desc:'年柱相冲有时预示着异地、出行、分离等情形——不一定是分手，而是命运安排了某些阶段性的距离考验。化解建议：用规律的联系和明确的共同计划对抗距离感，心远才是感情的真正杀手。' },
  ],
  '日支相冲': [
    { icon:'⚡', badge:'注意', title:'婚姻宫的天然张力',  desc:'日支是命理中的婚姻宫，日支相冲意味着两人在婚姻层面存在天然的张力。这不是"不能在一起"，而是"在一起需要更用心"——命里有些摩擦，需要用智慧和包容来化解。化解建议：选择地支相合的吉年结婚，是化解日支冲最有效的方式之一。' },
    { icon:'⚡', badge:'预防', title:'生活习惯的大不同',  desc:'日支影响一个人的日常生活节奏与习惯。日支相冲的伴侣，在生活习惯上往往差异显著——作息时间、整洁程度、饮食偏好、消费方式，处处都是可能引发小火花的地方。化解建议：列一张"彼此需要适应的习惯清单"，用书面的方式达成协议。' },
    { icon:'⚡', badge:'留意', title:'容易因小事争吵',    desc:'日支相冲的组合，日常生活中小摩擦较多——有时候会为了一件小事吵得天翻地覆，事后又觉得没什么大不了。化解建议：约定"吵架规则"：不翻旧账，不说"你总是""你从不"，争完了必须和好。' },
  ],
  '月柱相冲': [
    { icon:'🔥', badge:'注意', title:'感情节奏不同步',    desc:'月柱主感情，月柱相冲往往体现为两人在恋爱节奏上的错位——一个想快一点，另一个想慢一点；一个感情敏感，另一个反应迟钝。化解建议：把"我需要什么"直接说出来，而不是等对方猜。' },
    { icon:'🔥', badge:'预防', title:'兴趣爱好差异较大',  desc:'月柱相冲的伴侣，往往在兴趣爱好上差异较大，很难找到能一起享受的共同活动。时间一长，各玩各的，共同语言越来越少，感情也在不知不觉中疏远。化解建议：每个月至少找一件两人都愿意一起尝试的新事物。' },
    { icon:'🔥', badge:'留意', title:'情感付出理解不同',  desc:'月柱相冲有时体现为两人对感情付出的理解不同——一人觉得花时间陪伴是爱，另一人觉得解决实际问题是爱。化解建议：了解对方的"爱的语言"，用对方能接收的方式去爱。' },
  ],
  '天干相克': [
    { icon:'⚖️', badge:'注意', title:'本能的控制感',       desc:'天干代表一个人外显的性格与行为方式，天干相克往往带来一方对另一方本能的管控欲——不一定是恶意，但确实会让被克的一方感到压力与束缚。化解建议：克方需提醒自己"TA不是我的作品，是我的伴侣"，让对方保有自主空间。' },
    { icon:'⚖️', badge:'预防', title:'口舌之争较多',       desc:'天干相克的组合，在语言表达上容易产生摩擦——措辞方式、语气、说话节奏都可能成为导火索。有时候不是说了什么，而是怎么说的，让对方觉得受到了攻击。化解建议：练习"非暴力沟通"——描述事实，而不是评价对方。' },
    { icon:'⚖️', badge:'留意', title:'越吵越爱',           desc:'有趣的是，天干相克的组合往往越吵越放不下对方。那种"我气你气我，但就是走不了"的体验，在命理上有一个名字叫"克中带情"。这不是折磨，是命里的深度羁绊。化解建议：把吵架的能量转化为坦诚沟通的动力，认真复盘"我们真正在争什么"。' },
  ],
  '三刑': [
    { icon:'🌀', badge:'注意', title:'细节里的摩擦',       desc:'三刑代表一种反复出现的细小摩擦——不是大冲突，而是生活细节里的各种小别扭：你觉得理所应当的事，TA偏偏不这么做；你觉得明显的暗示，TA就是看不懂。化解建议：把期待明确说出来，减少靠对方"应该懂的"来维持关系。' },
    { icon:'🌀', badge:'预防', title:'权力的暗战',         desc:'某些三刑组合有"权力争夺"的特质，两人都有一定的自我意志，都不太愿意先低头，在决策层面容易形成暗中较劲的模式。化解建议：定期坐下来讨论"我们的关系里，谁负责什么"，把规则明确化，比互相试探要健康得多。' },
    { icon:'🌀', badge:'留意', title:'相刑带来的成长',     desc:'三刑不只是麻烦，它也是成长的催化剂。相刑的两人，往往逼着彼此面对自己不想面对的那些东西——这种互相照镜子，虽然不舒服，但能帮助彼此成为更完整的人。化解建议：感谢让你不舒服的那个部分，那往往是你最需要成长的地方。' },
  ],
  '六害': [
    { icon:'🌫', badge:'注意', title:'无形的消耗',         desc:'六害是一种隐性的消耗关系——不像相冲那样激烈，但有一种难以言说的"不对劲"。有时会莫名感到疲惫，或者感觉两人之间有什么东西在悄悄流失，却又说不清是什么。化解建议：多做增进感情的共同体验，用行动填充那些无形的裂缝。' },
    { icon:'🌫', badge:'预防', title:'误解频发',           desc:'六害组合在沟通上容易出现"我不是这个意思，你为什么要这样理解"的情况。双方的表达方式和接收方式存在偏差，同样一句话，一人觉得在表达关心，另一人觉得在指责。化解建议：养成"确认式沟通"习惯——说完话后问"你理解的是什么"。' },
    { icon:'🌫', badge:'留意', title:'缘来容易，守住需努力', desc:'六害组合有时有"相遇容易，维系困难"的特质——一见如故，但长久相处需要更多有意识的经营。化解建议：把感情当作一个需要定期维护的系统，每周安排一次认真的二人时光。' },
  ],
};

// ═══════════════════════════════════════════════════════════════════════════════
// 三、相处建议 ADVICE
// ═══════════════════════════════════════════════════════════════════════════════
const ADVICE_RAW: Record<string, string[]> = {
  '木火': [
    '给彼此燃烧的空间——不要粘成一体，要像两棵并排的树，根相连，枝各自伸向不同的方向。支持对方的同时，保留各自的独立领域。',
    '与其等待对方先迈出那一步，不如自己先动。主动表达喜欢，主动策划约会，主动说出"我今天想见你"——你们都需要具体的行动来感受爱。',
    '木火相遇，情绪温度都不低，吵起来可能比较激烈。建议约定：吵完必须当天和好，不许带着怒气睡觉。快打快和，不积累，是这个组合维护感情的核心原则。',
    '[A]给予[B]的滋养往往是默默的，[B]可能把这份给予当作理所当然。建议[B]时常主动说出"谢谢你为我做的那些"——被看见的付出，才会持续。',
  ],
  '火土': [
    '[A]可能会觉得[B]反应太慢、太保守；[B]可能会觉得[A]太冲动、不踏实。建议[A]在提出新想法时，给[B]充足的思考时间；[B]在[A]兴奋的时候，先回应热情，再分析风险。',
    '建议两人养成"共同计划"的习惯——每月一起制定一个小目标，一起执行，这样[B]有了明确的方向，[A]有了持续的动力，两人的步调就对齐了。',
    '火土组合在长期生活中，最常见的摩擦来自于"我以为你会做"——建议尽早明确日常生活的分工，包括财务管理方式，越早厘清，越少摩擦。',
    '土性的人不擅长表达，火性的人需要被确认。建议[B]练习直接说出"我爱你""我很高兴有你"——哪怕只是一句简短的话，对[A]来说，意义却是巨大的。',
  ],
  '土金': [
    '[A]需要明白：无条件的接纳，有时会让[B]失去成长的动力。真正的包容，是在接纳对方现在的样子的同时，也愿意一起面对需要改变的地方。',
    '金性的[B]需要被看见和认可。[A]最有效的爱，是在人前给予[B]真诚的肯定和欣赏——不是夸张地吹捧，而是真实地说出"我觉得你这方面做得很好"。',
    '土金组合不需要每时每刻热烈地交流，有时只是坐在同一个房间里各自做事，就是一种深厚的陪伴。不要误以为安静就是疏离，这个组合的爱，很多时候是安静流淌的。',
    '当分歧出现时，[A]容易沉默压抑，[B]容易锋芒毕露。建议[A]练习在积累到临界点前先开口，[B]练习在说话前思考"我想达到什么目的"。',
  ],
  '金水': [
    '金水组合都不是擅长倾诉的类型，很容易陷入"两个人都在等对方先说"的僵局。建议约定：每周有一次"没有手机的二人对话时间"，哪怕只有20分钟，也要真正地交流。',
    '水性的人情感丰富但容易停留在感受层面，金性的人想法独到但有时表达不出来。建议两人多用行动来表达爱意——订一次旅行，做一顿饭，送一个意外的小惊喜。',
    '金水组合需要仪式感来维系情感的温度——不需要多贵重，只需要有意义。比如每周五晚上的固定约会，或者每年纪念日的专属活动。仪式感让关系有了记忆点和期待感。',
    '当外部压力变大时，金水组合都有向内收缩、独自承担的倾向。建议两人在遇到困难时，第一反应是找对方说"我现在很难，需要你在"，而不是"没事，我自己能处理"。',
  ],
  '水木': [
    '[A]的滋养是这段关系的养料，但[A]也要注意不要无限透支自己。如果付出换不来应有的回应，[A]会渐渐干涸。建议[A]明确说出自己的需求，让[B]知道"我需要你给我补水"。',
    '水木组合非常适合共同孕育一个长期目标——可以是一次说走就走的旅行计划，一个共同的创业想法，或者一个关于未来生活的蓝图。有了共同的"树苗"要照料，两人的关系会有一种向前的牵引力。',
    '[B]练习告诉[A]自己的感受，哪怕只是"我今天心情不好"这样简单的一句话——[A]最怕的不是[B]有情绪，而是不知道[B]在想什么。',
    '水木组合的感情需要持续地注入新鲜感，才能保持生机——固化的关系模式对这个组合尤其有害。建议每隔一段时间，一起尝试一件完全没做过的事。',
  ],
  '木土': [
    '[A]的直接反馈能帮助[B]成长，但表达方式很重要——建议[A]在提出批评前先给予肯定，让[B]能更好地接收意见，而不是产生防御心理。',
    '[B]的包容是这段关系的稳定器，但也要注意：无底线的接纳有时会让[A]失去自我约束。适当让[A]看到你的底线，是对这段关系负责。',
    '磨合期可能会比较长，建议两人在前半年都保持耐心，给对方足够的时间了解彼此的思维方式，不要因为一时的不理解就轻易放弃。',
    '深度连接需要时间来建立——多创造两人独处、深度交流的机会，让这段关系的根扎得更深。',
  ],
  '火金': [
    '[A]的热情能打开[B]的心扉，但也要注意节奏——[B]需要一些时间适应[A]的热烈。建议[A]在推进关系时保持一定的节奏感，给[B]适当的空间。',
    '[B]的稳定是这段关系的底座——遇到分歧时，[B]不妨主动保持冷静，用理性的方式引导讨论，而不是针锋相对。',
    '两人都是"爱得认真"的类型——建议坦诚地谈清楚彼此对这段感情的期望和边界，提前对齐，减少因误解而产生的摩擦。',
    '一起做一件充满热情的事——一起报一个兴趣班，一起规划一次说走就走的旅行，共同的热烈体验能快速拉近心理距离。',
  ],
  '土水': [
    '[A]给[B]的稳定是一种珍贵的礼物，但也要注意：过于稳定有时会让[B]感到被束缚。给[B]保留一些流动的空间，是对[B]天性的尊重。',
    '[B]的情感流动性能为这段关系带来生机，建议[B]多把内心的感受说出来，让[A]理解[B]的内心世界，而不是让[A]总是去猜。',
    '建立一个共同的"安全港湾"——在压力大的时候，两人约定一起做一件放松的事，让对方感受到"有你在，我不需要一个人扛"。',
    '重要决定前多交流彼此的感受与想法，不要让理性主导一切——[B]的直觉有时候比[A]的分析更准，值得倾听。',
  ],
  '水火': [
    '沟通时，[A]尽量先听完[B]说的，再给出反馈——[B]需要感受到被理解，然后才能接受[A]的建议。[A]的清醒是礼物，但给得太早会变成打压。',
    '[A]的冷静和[B]的热烈能形成绝妙的配合——在面对挑战时，充分发挥各自的优势，[B]负责冲锋，[A]负责把方向。',
    '磨合期注意互相尊重彼此的性格差异，不要试图把对方改造成和自己一样——正是这种"不同"，才是这段关系最大的价值所在。',
    '一起经历一件需要两人配合的事——无论是一次旅行还是一个共同项目，合作中的磨合往往比日常相处更能加深理解。',
  ],
  '金木': [
    '[A]的建议是出于真心，但[B]有时需要的不是解决方案，而是被倾听。建议[A]在给建议前先问："你现在需要我听你说，还是帮你想办法？"',
    '[B]的创意需要[A]的执行力来落地——建议两人在各自擅长的领域里充分信任对方，减少在对方"地盘"里指手画脚。',
    '两人都是有想法有原则的类型，遇到分歧时不必急于说服对方，给彼此一些时间消化，冷静后再讨论，效果会好很多。',
    '[A]的"修剪"是爱的一种表达方式，但[B]也需要听到[A]的肯定——批评之后记得补上一句真心的欣赏，让[B]知道[A]是在帮TA，不是在否定TA。',
  ],
  '木木': [
    '两人都是追求自由与成长的类型，要避免因各自的事业或兴趣而疏忽了感情的经营——定期安排专属的二人时光，让彼此都感受到"在我心里，你比任何事都重要"。',
    '双木组合都有一定的自我意志，遇到分歧时建议用"协商"代替"坚持"——你们都是聪明人，只要愿意坐下来谈，通常都能找到让双方都满意的方案。',
    '一起追求一个共同的目标——无论是旅行、学习还是创业，共同的成长方向是这个组合感情最有效的粘合剂。',
    '注意在支持彼此的同时，也要接受彼此的不完美——不要用理想化的标准要求对方，接受那个真实的、有缺陷的TA，才是真正的爱。',
  ],
  '火火': [
    '双火组合情绪温度都高，争起来可能比较激烈。建议约定一个"冷静规则"：情绪激动时，给对方也给自己20分钟冷静，冷静后再谈，效果会好得多。',
    '两人的热情都需要出口——建议定期一起做一件充满能量的事：去看一场演唱会，去尝试一项极限运动，或者一起策划一次说走就走的旅行。',
    '双火容易在小事上较劲，建议建立一个"谁主导什么"的分工原则，减少在日常决策上的摩擦，把热情用在更有价值的地方。',
    '记得给彼此留一点安静的空间——不是所有时刻都需要充满能量，偶尔一起什么都不做地安静坐着，也是一种珍贵的亲密感。',
  ],
  '土土': [
    '双土组合容易进入"太稳定"的舒适区，建议主动注入新鲜感——一起去一个从没去过的地方，尝试一件从没做过的事，让感情保持活力。',
    '建议两人约定定期"复盘"感情——不是要找茬，而是聊聊"我们有没有什么可以做得更好的地方"，用经营事业的认真度来经营感情。',
    '土土组合都不擅长表达，但情感需要被说出来。建议两人都练习用语言表达感谢和爱意——哪怕只是"今天你做的那顿饭很好吃，谢谢你"。',
    '共同建立一个仪式感——每年纪念日的专属活动，每月的固定约会，这些小小的仪式，是这段关系稳定与深厚的最好见证。',
  ],
  '金金': [
    '两个属金的人都有较强的自我意志，遇到分歧时，建议用"各负责一个领域"的方式分工，减少在同一件事上的角力。',
    '双金组合都不擅长主动示弱，但感情需要偶尔的脆弱来加深连结。建议两人都试着在对方面前展示自己不那么坚强的一面——被接住的脆弱，是信任的开始。',
    '一起欣赏有质感的东西——一场高水准的音乐会，一顿精心烹制的晚餐，这类共同的品质体验，能强化两人对感情"值得认真对待"的认知。',
    '金金组合都是"行动派"，建议多用行动代替语言来表达爱意——计划一次专属的旅行，买一份TA一直想要的礼物，这些具体的行动比说一万句"我爱你"更有力量。',
  ],
  '水水': [
    '双水组合情感都很丰富，但也容易陷入情绪化——建议两人都练习在情绪激动时先给自己一段冷静时间，而不是第一时间倾泻情绪。',
    '双水组合都很擅长感受，但有时行动力不足。建议把感受转化为具体的行动：把"我想和你在一起"变成"我帮你订了周六的电影票"。',
    '一起做一些需要思考和深度的事——看一本书，聊一个关于人生的话题，参加一个展览。智识上的共鸣是双水组合感情的重要养分。',
    '双水组合都需要一些独处的时间来补充能量。建议彼此理解并尊重对方偶尔需要独处的需求，不要把对方的"独处"误解为"不想见你"。',
  ],
};

// Q1-Q5 问卷联动建议
const Q_ADVICE: Record<string, Record<string, string>> = {
  q1: {
    '一见钟情': '你们的开始足够浪漫，但所有浪漫的开始都需要被日常的温柔接住。建议在度过蜜月期后，主动问对方："你最近有什么让你困扰的事吗？"——把关系从浪漫带向深度，是让一见钟情走向长久的必经之路。',
    '慢慢走进': '你们是慢热型的缘分——正因为慢，所以踏实。细水长流的缘分，往往比一见钟情更经得起考验。继续慢慢来，每一步都算数。',
    '网络相识': '网络相识的你们，线上的了解可能已经很深，但线下的真实接触同样重要。建议多创造线下见面的机会——面对面感受对方的存在，远比隔着屏幕更有温度。',
    '朋友介绍': '朋友介绍的缘分有个优势：你们有共同的社交圈，有更多共同的背景与语境。建议充分利用这个优势，多参与共同朋友的活动，在自然的社交场合里加深了解。',
  },
  q2: {
    '磁铁相吸': '强烈的吸引力是这段关系的礼物，但也要注意：在激情之外，培养真正的友谊——能聊天、能一起无聊、能一起做不浪漫的事，才是长久关系的真正底座。',
    '相似灵魂': '相似的灵魂相遇，是最幸运的事之一。你们有相同的底层价值观，这会让你们在人生重大决策上更容易达成一致。建议保持这种精神层面的连接，多分享彼此的读书心得、想法感悟。',
    '互补拼图': '互补是这段关系的核心价值，但互补也意味着你们在很多地方的出发点不同。建议多花时间了解对方的思维方式——带着好奇而非评判地探索，你会发现对方的"不一样"是你的宝藏。',
    '还没感觉到': '感情的种子，有时发芽慢一点。没有感觉不等于没有缘分，有时候是因为还没有打开那扇门。建议给自己和对方多一点时间，同时保持真实——诚实面对比继续等待更尊重彼此。',
  },
  q5: {
    '不到一个月': '刚刚开始，一切都是新鲜的。这个阶段最重要的事，是真实地展现自己，而不是表演一个更好的版本——越早让对方认识真实的你，越能建立真正的信任。',
    '1-6个月':    '你们正处于"了解期到深入期"的过渡阶段，是感情最关键的窗口期。这个阶段容易因为了解加深而出现"滤镜消退"的感觉——那很正常，看见对方真实的样子，是爱情走向长久的必经之路。',
    '半年以上':   '经过了初期的兴奋期，你们现在进入了真正考验感情深度的阶段。建议有意识地注入新鲜感——一起做一件从没做过的事，或者认真谈一次关于未来的计划，让关系继续向前走，而不是停在原地。',
    '还没在一起': '八字已经测算完了，现在就差你迈出那一步了。命运能把你们的缘分写进命盘，但它不会替你去说那句话——喜欢，就去说。八字能告诉你这段缘值不值得，但最终能不能走到一起，要靠你自己。',
  },
};

// ═══════════════════════════════════════════════════════════════════════════════
// 四、流年排盘 LIUNIAN（2025-2030）
// ═══════════════════════════════════════════════════════════════════════════════
const LIUNIAN_DATA: Record<number, { gz: string; stars: number; note: string; fullDesc: string }> = {
  2025: { gz:'乙巳年', stars:5, note:'🌸 桃花大运', fullDesc:'2025年乙巳，乙木桃花之气叠加巳火驿马之力，是近年来感情运势最旺的年份之一。乙木主桃花，巳火主行动与热情——这一年，感情会以前所未有的速度推进。已有伴侣者关系将进入全新阶段；暗恋者，2025年是表白成功率最高的年份。特别吉月：3月、5月、7月。' },
  2026: { gz:'丙午年', stars:5, note:'🎊 婚姻吉年', fullDesc:'2026年丙午，双火叠加，是感情能量最充沛的年份。婚姻运势极旺，丙午年是命理历法中最适合步入婚姻的年份之一。如果2025年是种下了种子，2026年就是开花的时候。520前后，丙午年的婚姻能量达到全年顶峰。' },
  2027: { gz:'丁未年', stars:3, note:'🌿 稳固深化', fullDesc:'2027年丁未，火土相生，是一个"稳固与深化"之年。经历了2025、2026的桃花与婚姻浪潮，2027年的感情运势回归平稳——适合夯实感情的基础，建立两人的生活方式，把感情从"热恋"转化为"长情"。' },
  2028: { gz:'戊申年', stars:4, note:'💼 共创事业', fullDesc:'2028年戊申，土金相生，财运与感情双旺。这一年，两人共同的事业或财务目标会成为感情的粘合剂——一起买房、一起投资、一起规划家庭的未来。戊申年利于"共建"，是感情转化为人生合伙的最佳时机。' },
  2029: { gz:'己酉年', stars:3, note:'✨ 细腻深情', fullDesc:'2029年己酉，桃花之气再现（酉为桃花地支），但己酉年的桃花更加细腻、深沉。这一年，感情中的小浪漫和小惊喜会特别有效果——一封手写的信，一个意外的小礼物，就能让感情温度显著提升。' },
  2030: { gz:'庚戌年', stars:2, note:'⚡ 考验之年', fullDesc:'2030年庚戌，金土组合，是"检验"之年。感情将面临某种形式的考验——可能是外部压力，可能是价值观的碰撞。庚戌年的使命是"去伪存真"，经得住这一年考验的感情，将在接下来的很多年里无比坚固。' },
};

// ═══════════════════════════════════════════════════════════════════════════════
// 五、最佳发展时机 TIMING
// ═══════════════════════════════════════════════════════════════════════════════
const TIMING_DATA = {
  high: [ // score >= 85
    { date:'2025年\n3—5月',   desc:'乙巳年桃花入命，感情升温最佳窗口，表白、确认关系成功率极高，勇敢迈出第一步！', badge:'best' as const, badgeText:'大吉' },
    { date:'2026年\n520前后', desc:'丙午年婚姻宫旺，是步入婚姻的绝佳时节，求婚、订婚、规划同居均大吉。',             badge:'best' as const, badgeText:'上上' },
    { date:'2025年\n7—9月',   desc:'流年遇刑冲，感情易生波折，不宜在此期间做重大承诺，建议多陪伴少压力。',           badge:'caution' as const, badgeText:'谨慎' },
    { date:'2028年\n全年',    desc:'戊申年财运与感情双旺，适合共同创业、置业，将感情转化为人生合伙的黄金时期。',       badge:'best' as const, badgeText:'大吉' },
  ],
  good: [ // score 70-84
    { date:'2025年\n5—7月',   desc:'乙巳年桃花月，感情能量较旺，是推进关系的好时机，主动行动比等待更有效。',           badge:'best' as const, badgeText:'吉' },
    { date:'2026年\n全年',    desc:'丙午婚姻吉年，命盘的一些冲克会在这一年自然化解，感情走向稳定的绝佳节点。',          badge:'best' as const, badgeText:'上吉' },
    { date:'2025年\n8—10月',  desc:'流年冲克期，感情容易出现小波折，建议维持现状，不宜在此阶段做重大决定。',            badge:'caution' as const, badgeText:'谨慎' },
    { date:'2029年\n秋季',    desc:'己酉年桃花地支，细腻深情的感情节点，适合用小仪式感深化关系。',                      badge:'best' as const, badgeText:'吉' },
  ],
  medium: [ // score < 70
    { date:'2026年\n丙午年',  desc:'丙午婚姻吉年能有效化解命盘中的冲克，是这段缘分最好的"化解窗口"，珍惜把握。',       badge:'best' as const, badgeText:'吉' },
    { date:'2025年\n3月',     desc:'乙巳年春季，感情能量上升，适合主动创造相处机会，增加彼此了解的深度。',               badge:'best' as const, badgeText:'可' },
    { date:'2025年\n7—10月',  desc:'流年冲克叠加，此期间感情摩擦较多，建议保持平稳，减少重大决定，以陪伴代替压力。',    badge:'caution' as const, badgeText:'小心' },
  ],
};

// ═══════════════════════════════════════════════════════════════════════════════
// 六、转运技巧 ZHUANGYUN
// 按五行缺失分类，可叠加
// ═══════════════════════════════════════════════════════════════════════════════
const ZHUANGYUN_RAW: Record<WuXing, ZhuangyunItem[]> = {
  '水': [
    { icon:'💧', title:'蓝色约会日',   desc:'合盘缺水，感情流动性略显不足。建议每月选一天作"蓝色日"——约会时带一点蓝色，去水边或有水的地方（湖边、海边、水族馆），在水边聊那些平时不容易说出口的心里话。水的能量会让沟通变得更自然流畅。' },
    { icon:'🌊', title:'雨天约会',     desc:'命理缺水的人，在雨天往往会有意想不到的感情突破——雨水弥补了命中所缺，让人更容易打开心扉，更容易表达真实的感受。主动在雨天安排一次约会，两人打着一把伞，聊那些平时没机会说的话。' },
    { icon:'🐟', title:'共养水景',     desc:'在家中养一缸水草或一个小型水族箱，放置在感情位（东南方）。水的流动代表感情的活力，水草的生长代表关系的生机。一起照料这个小小的水世界，也是一种日常的感情维护仪式。' },
  ],
  '火': [
    { icon:'🕯️', title:'烛光约会的力量', desc:'蜡烛是最便捷的补火工具，也是最有仪式感的约会道具。建议每月至少一次烛光晚餐——在家点上几根蜡烛，做一顿简单的饭，关掉手机，只有你们两个人和那几束火光。火的能量会让感情更加温热。' },
    { icon:'🔴', title:'红色系点缀',    desc:'合盘缺火，感情中可能缺少那种热烈与激情的底色。建议在约会时加入红色或橙色元素——一条红色围巾、一束火红的玫瑰、一顿以"热"著称的餐厅，在潜移默化中提升两人之间的热情温度。' },
    { icon:'🎵', title:'一起做热烈的事', desc:'命缺火的两人，需要主动创造热情的体验。建议一起参加一项充满能量的活动：一起跳舞，一起去看一场现场演唱会，一起尝试热带风情的旅行目的地。热烈的共同体验，是为感情补火的最直接方式。' },
  ],
  '木': [
    { icon:'🌿', title:'绿色植物入户',  desc:'命缺木，感情中可能缺少生机与成长感。建议在家中（尤其是东方或东南方）摆放生命力旺盛的绿色植物——绿萝、富贵竹都是极好的选择。让家中充满木气，感情也会随之更有活力。' },
    { icon:'🌱', title:'一起种一棵树',  desc:'这不只是补木，更是一个意义深远的感情仪式。一起选择一棵植物，给它起一个你们专属的名字，一起照料它、看它生长。每次新叶展开，都是这段关系生机的象征。' },
    { icon:'🏞️', title:'绿色系约会',   desc:'建议把约会地点选在有自然绿意的地方——公园、植物园、郊野步道、茶园。自然界的木气会弥补命盘中的不足，同时，在自然环境中约会，有助于让两人都放松下来，打开更真实的自己。' },
  ],
  '土': [
    { icon:'🍳', title:'一起下厨',      desc:'烹饪是最接地气的土行活动——食材来自土地，火焰将其转化为滋养。对于命缺土的组合，建议把"一起做饭"变成固定的感情仪式。真正一起站在厨房里，切菜、炒菜、品尝——这个简单的活动能建立一种脚踏实地的踏实感。' },
    { icon:'💛', title:'黄水晶与土系宝石', desc:'建议佩戴黄水晶、虎眼石、玛瑙（黄色或棕色系）——这些宝石携带土的稳定能量，有助于增强安全感，让两人在感情中都更踏实，更有根基感。' },
    { icon:'🏛️', title:'去有历史感的地方旅行', desc:'土代表厚重与历史。建议把旅行目的地选在有厚重文化历史底蕴的地方——古镇、古城、博物馆、历史遗址。在这些地方感受时间的厚重，会自然地让人沉淀下来，让感情在时间的维度上获得新的深度。' },
  ],
  '金': [
    { icon:'💍', title:'互赠金属类饰品', desc:'建议在感情的重要节点（表白日、纪念日）互赠金属类饰品——金戒指、银手环、不锈钢手表。金属饰品不只是礼物，更是金行能量的载体，有助于增强两人关系的坚定性与持久性。' },
    { icon:'🍂', title:'秋天是最好的时机', desc:'秋天（尤其是农历七月至九月）是金气最旺的季节，对于命缺金的组合，秋天是全年感情能量最充沛的时候。建议把重要的感情决定（表白、求婚、确认关系）安排在秋天，顺势而为，事半功倍。' },
    { icon:'🎼', title:'一起欣赏有质感的东西', desc:'金代表品质与精华。建议一起去欣赏有高质感的东西——一场高水准的音乐会，一个精品艺术展，一顿精心烹制的晚餐。共同的品质体验，会在潜移默化中强化两人对感情"值得认真对待"的认知。' },
  ],
};

// ═══════════════════════════════════════════════════════════════════════════════
// 七、专属姻缘签 SIGNS
// ═══════════════════════════════════════════════════════════════════════════════
// 格式：按"分数等级"+"五行对"查找；[A名]替换为nameA
const SIGNS_DATA: {
  condition: (score: number, key: string) => boolean;
  grade: string;
  name: string;
  poem: string[]; // 4 行，[A名] 为替换占位
}[] = [
  // ── 上上签（score >= 85）按五行对 ──
  { condition: (s,k) => s >= 85 && k === '木火',
    grade:'上上签', name:'桃花天定',
    poem:['[A名]逢春日', '桃花映两心', '月老牵红线', '共赴好姻缘'] },
  { condition: (s,k) => s >= 85 && k === '水木',
    grade:'上上签', name:'春雨润芳',
    poem:['春雨润新芽', '[A名]是那雨', '滋养了你心', '花开正当时'] },
  { condition: (s,k) => s >= 85 && k === '火土',
    grade:'上上签', name:'炉火温情',
    poem:['[A名]心似火', '温暖了这土', '土中生万物', '共筑一片家'] },
  { condition: (s,k) => s >= 85 && k === '土金',
    grade:'上上签', name:'厚土藏金',
    poem:['深土藏真金', '[A名]是那土', '守候日月长', '金光终璀璨'] },
  { condition: (s,k) => s >= 85 && k === '金水',
    grade:'上上签', name:'月下相逢',
    poem:['月下两相逢', '[A名]与[B名]', '金水本同源', '此生共长情'] },
  { condition: (s,k) => s >= 85 && k === '木木',
    grade:'上上签', name:'并肩向光',
    poem:['两树并肩立', '[A名]与[B名]', '共向阳光处', '此后皆自由'] },
  { condition: (s,k) => s >= 85 && k === '火火',
    grade:'上上签', name:'双星燃烧',
    poem:['[A名]是火', '[B名]亦是火', '双星共燃时', '世界皆明亮'] },
  { condition: (s,k) => s >= 85 && k === '水水',
    grade:'上上签', name:'心海相遇',
    poem:['深海两相遇', '[A名]知[B名]', '万语皆沉默', '心意已相知'] },
  { condition: (s,k) => s >= 85 && k === '土土',
    grade:'上上签', name:'厚土相依',
    poem:['厚土出好田', '[A名]与[B名]', '相依岁月里', '稳稳到白头'] },
  { condition: (s,k) => s >= 85 && k === '金金',
    grade:'上上签', name:'高山流水',
    poem:['高山遇高山', '[A名]识[B名]', '千里寻知音', '今生算找到'] },
  // ── 上上签 兜底（score >= 85）──
  { condition: (s,_) => s >= 85,
    grade:'上上签', name:'木火光华',
    poem:['木生火，火生情', '[A名]与[B名]一见有缘', '春来花自开', '此生不相忘'] },
  // ── 上签（score 70-84）──
  { condition: (s,_) => s >= 70,
    grade:'上签', name:'缘来有时',
    poem:['缘深不必急', '[A名]等一时', '花开有时节', '好缘自然至'] },
  { condition: (s,_) => s >= 70,
    grade:'上签', name:'细水长流',
    poem:['不求海啸来', '只求溪水清', '[A名]遇[B名]', '淡淡长相映'] },
  // ── 中上签（score < 70）──
  { condition: (s,_) => s >= 55,
    grade:'中上签', name:'缘浅情可深',
    poem:['缘浅非无情', '[A名]莫心急', '用心浇一浇', '花自会盛开'] },
  { condition: (s,_) => s >= 55,
    grade:'中上签', name:'磨砺出真金',
    poem:['好事多磨时', '[A名]勿轻弃', '磨砺出真金', '此缘值百遍'] },
  // ── 加持型兜底签 ──
  { condition: (_s,_k) => true,
    grade:'转运签', name:'执手共渡',
    poem:['风浪非无情', '考验两颗心', '[A名]执[B名]手', '共渡即成真'] },
];

// ─── 辅助工具 ─────────────────────────────────────────────────────────────────
function pick<T>(arr: T[], n: number): T[] {
  const copy = [...arr];
  const result: T[] = [];
  while (result.length < n && copy.length > 0) {
    const idx = Math.floor(Math.random() * copy.length);
    result.push(copy.splice(idx, 1)[0]);
  }
  return result;
}

function pickFirst<T>(arr: T[], n: number): T[] {
  return arr.slice(0, n);
}

// ─── 主函数 ────────────────────────────────────────────────────────────────────
export interface BuildInput {
  nameA: string;
  nameB: string;
  elemA: WuXing;
  elemB: WuXing;
  gzA: GanzhiPillar[];
  gzB: GanzhiPillar[];
  score: number;
  questionnaire?: Record<string, string>;
}

export function buildReportContent(input: BuildInput) {
  const { nameA, nameB, elemA, elemB, gzA, gzB, score, questionnaire = {} } = input;

  // 1. 确定组合键与A/B交换
  const [key, swapped] = pairKey(elemA, elemB);
  const fA = swapped ? nameB : nameA;
  const fB = swapped ? nameA : nameB;
  const f = (text: string) => fill(text, fA, fB);
  const fAB = (text: string) => fill(text, nameA, nameB);

  // 2. 缘分亮点
  const rawHighlights = HIGHLIGHTS_RAW[key] ?? HIGHLIGHTS_RAW['木火'];
  // 特殊关系亮点
  const specials = detectSpecial(gzA, gzB);
  const specialItems: HighlightItem[] = [];
  for (const sp of specials.slice(0, 1)) {
    const spRaw = HIGHLIGHTS_RAW[sp];
    if (spRaw) specialItems.push({ ...spRaw[0], desc: fAB(spRaw[0].desc) });
  }
  const wxItems = pick(rawHighlights, Math.min(4 - specialItems.length, rawHighlights.length))
    .map(h => ({ icon: h.icon, title: h.title, desc: f(h.desc) }));
  const highlights: HighlightItem[] = [...specialItems, ...wxItems].slice(0, 4);

  // 3. 隐患预警
  const warningTypes = detectWarnings(gzA, gzB);
  const warnings: WarningItem[] = [];
  for (const wt of warningTypes.slice(0, 3)) {
    const pool = WARNINGS_RAW[wt] ?? [];
    if (pool.length > 0) {
      const item = pool[Math.floor(Math.random() * pool.length)];
      warnings.push({ ...item, desc: fAB(item.desc) });
    }
  }
  // 保底：如果没有冲克，根据相克关系添加一条轻微预警
  if (warnings.length === 0 && relType(elemA, elemB) === 'ke') {
    const pool = WARNINGS_RAW['天干相克'];
    const item = pool[Math.floor(Math.random() * pool.length)];
    warnings.push({ ...item, desc: fAB(item.desc) });
  }
  // 最多3条
  const finalWarnings = warnings.slice(0, 3);

  // 4. 相处建议
  const advicePool = ADVICE_RAW[key] ?? ADVICE_RAW['木火'];
  const adviceItems = pickFirst(advicePool, 3).map(t => f(t));
  // Q1/Q2/Q5 问卷联动
  for (const qk of ['q5', 'q1', 'q2'] as const) {
    const ans = questionnaire[qk];
    if (ans && Q_ADVICE[qk]?.[ans]) {
      adviceItems.push(fAB(Q_ADVICE[qk][ans]));
      break;
    }
  }
  const advice = adviceItems.slice(0, 4);

  // 5. 流年排盘（固定2025-2030）
  const liunian = Object.entries(LIUNIAN_DATA).map(([yearStr, d]) => ({
    year: Number(yearStr),
    gz: d.gz,
    stars: d.stars,
    note: d.note,
    active: d.stars >= 4,
  }));

  // 6. 最佳发展时机
  const timingPool = score >= 85 ? TIMING_DATA.high : score >= 70 ? TIMING_DATA.good : TIMING_DATA.medium;
  const timing = timingPool.slice(0, 4);

  // 7. 转运技巧
  const missing = getMissingElems(gzA, gzB);
  const zhuangyunItems: ZhuangyunItem[] = [];
  const usedElems = new Set<WuXing>();
  for (const e of missing) {
    if (usedElems.size >= 2) break;
    const pool = ZHUANGYUN_RAW[e];
    if (pool.length > 0) {
      zhuangyunItems.push({ ...pool[Math.floor(Math.random() * pool.length)], desc: fAB(pool[Math.floor(Math.random() * pool.length)].desc) });
      usedElems.add(e);
    }
  }
  // 补充到4条（用通用颜色穿搭）
  const colorAdv: ZhuangyunItem = {
    icon: '🌸',
    title: '幸运颜色穿搭',
    desc: fAB(`约会时${nameA}穿${elemA === '木' ? '绿' : elemA === '火' ? '红' : elemA === '土' ? '黄' : elemA === '金' ? '白' : '蓝'}色系，${nameB}穿${elemB === '木' ? '绿' : elemB === '火' ? '红' : elemB === '土' ? '黄' : elemB === '金' ? '白' : '蓝'}色系，${elemA}${elemB}相配，彼此能量互相加持。`),
  };
  const moonAdv: ZhuangyunItem = {
    icon: '🕯️',
    title: '月圆许愿',
    desc: '每月望日（农历十五）二人同时看月亮，默想对彼此的心愿，月老自会感应。共同的仪式感，是感情最好的加持。',
  };
  const allZhuangyun = [...zhuangyunItems, colorAdv, moonAdv];
  const zhuangyun = allZhuangyun.slice(0, 4);

  // 8. 姻缘签
  const signMatch = SIGNS_DATA.find(s => s.condition(score, key)) ?? SIGNS_DATA[SIGNS_DATA.length - 1];
  const poem = signMatch.poem.map(line => fill(line, nameA, nameB));

  // 9. 五行关系描述
  const rel = relType(elemA, elemB);
  const relTag = rel === 'sheng'
    ? (SHENG[elemA] === elemB ? `🌿 ${elemA}生${elemB}` : `🌿 ${elemB}生${elemA}`)
    : rel === 'ke'
    ? (KE[elemA] === elemB ? `⚡ ${elemA}克${elemB}` : `⚡ ${elemB}克${elemA}`)
    : `✨ ${elemA}${elemB}比和`;
  const relDesc = rel === 'sheng'
    ? (SHENG[elemA] === elemB
      ? `${nameA}${elemA}命助长${nameB}${elemB}命，相辅相成，彼此滋养。`
      : `${nameB}${elemB}命助长${nameA}${elemA}命，相辅相成，彼此滋养。`)
    : rel === 'ke'
    ? `${elemA}${elemB}相克，磨合中见真情，相克不一定不合，制化得宜即为良缘。`
    : `同属${elemA}命，比肩同行，灵魂共鸣，同频共振。`;

  return {
    highlights,
    warnings: finalWarnings,
    advice,
    liunian,
    timing,
    zhuangyun,
    sign: {
      grade: signMatch.grade,
      name:  signMatch.name,
      poem,
      ganzhiA: [gzA[0].tg, gzA[0].dz, gzA[1].tg, gzA[1].dz],
      ganzhiB: [gzB[0].tg, gzB[0].dz, gzB[1].tg, gzB[1].dz],
    },
    wuxingRel: { tag: relTag, desc: relDesc },
    scoreDesc: rel === 'sheng'
      ? `命盘显示二人八字相生相合，${elemA}${elemB}交融，前世早有牵绊，今生得以重逢共度时光。`
      : rel === 'ke'
      ? `命盘显示二人五行存在相克，但克中有情，磨合越深，羁绊越难割舍，是命里注定的深度连接。`
      : `命盘显示二人同属${elemA}命，比肩同行，灵魂高度共鸣，是难得的同频之缘。`,
    shareCard: {
      grade: score >= 85 ? '天作之合' : score >= 75 ? '良缘天定' : score >= 65 ? '有缘有分' : '缘浅情深',
      wxTag: relTag,
      poemShort: `${poem[0]}，${poem[1]}\n${poem[2]}，${poem[3]}`,
    },
  };
}
